ロック

<h2>仲裁更新という問題</h2>

<h3>木の実の数を数えるという例</h3>

<p>
以下の流れのなかで本来は23 -> 43となるはずの記録が
23 -> 35となってしまっている。
</p>

<ol>
<li>Aさんが記録を見て「現在の木の実の個数」を調べる</li>
<li>木の実の個数は23である</li>
<li>Aさんは23に8を足して31を記録しようとする</li>
<li>31を記録する前にBさんが「現在の木の実の個数」を調べる</li>
<li>木の実の個数の記録はまだ23である</li>
<li>Bさんは23に12を足して35を記録しようとする</li>
<li>Aさんが実際に31を記録する</li>
<li>Bさんが実際に35を記録する</li>
</ol>

<p><a href="/computer/programming/algorithm/interceding_update.html">詳細</a></p>

<h2>ロックによる解決</h2>

<p>
操作のアトミック性を保証するという問題である。
解決方法のひとつとしてロックという手法がある。
</p>

<h3>中心となる考え方</h3>

<p>
操作を始める前に「使用中」を示す印をつけておくということ。
トイレ等に表示される「使用中」のランプのイメージ。
</p>

<h3>上記の例に即した説明</h3>

<ol>
<li>Aさんはまず「使用中」の印の有無を調べる</li>
<li>印がないので「使用中」の印をつける</li>
<li>記録を見ると23である</li>
<li>それに8を足して31を記録しようとする</li>
<li>Bさんが「使用中」の印の有無を調べる</li>
<li>印がついているのでBさんはしばらく待つことにする</li>
<li>Aさんが31を記録する</li>
<li>Aさんが「使用中」の印を消す</li>
<li>Bさんが「使用中」の印の有無を調べる</li>
<li>印がないので「使用中」の印をつける</li>
<li>記録を見ると31である</li>
<li>それに12を足して43を記録しようとする</li>
<li>43を記録する</li>
<li>「使用中」の印を消す</li>
</ol>

<h4>Aさんのしたこと</h4>

<ol>
<li>「使用中」の印の有無を調べる</li>
<li>印がないので「使用中」の印をつける</li>
<li>記録を見ると23である</li>
<li>それに8を足して31を記録しようとする</li>
<li>実際に31を記録する</li>
<li>「使用中」の印を消す</li>
</ol>

<h4>Bさんのしたこと</h4>

<ol>
<li>「使用中」の印の有無を調べる</li>
<li>印があるのでしばらく待つ</li>
<li>適当な時間待ち再度「使用中」の印の有無を調べる</li>
<li>印がないので「使用中」の印をつける</li>
<li>記録を見ると31である</li>
<li>それに12を足して43を記録しようとする</li>
<li>実際に43を記録する</li>
<li>「使用中」の印を消す</li>
</ol>

<h4>ポイント</h4>

<p>
Bさんが「使用中」の印の有無を調べているところがポイントである。
これによってAさんの「読み込み、演算、書き込み」へのわりこみを防ぐことができる。
</p>

<h2>ロックの問題点</h2>

<h3>無限後退</h3>

<p>
上記でうまくいくように思う。
しかしよく考えると以下のような場合が考えられる。
</p>

<ol>
<li>Aさんが「使用中」の印の有無を調べる</li>
<li>印がないので「使用中」の印をつけようとする</li>
<li>Aさんが印をつける前にBさんが「使用中」の印の有無を調べる</li>
<li>Bさんも印がないので「使用中」の印をつけようとする</li>
<li>Aさんが「使用中」の印をつける</li>
<li>Bさんが「使用中」の印をつける</li>
<li>以下、Aさんの操作とBさんの操作がまざりあってしまう</li>
</ol>

<p>
問題は「使用中かどうか調べて」「使用中の印をつける」という一連の流れが
アトミックな操作である必要があるということだ。
</p>

<p>
「使用中の印」に対する「使用中」の印が必要になる。
これは<a href="http://ja.wikipedia.org/wiki/無限後退">無限後退</a>となる。
</p>

<p>
<a href="/computer/programming/algorithm/lock/infinite_regress.html">解決策</a>
</p>

<h3>ロックが解除されない</h3>

<p>
たとえばAさんが「使用中」の印をつけたあと、別の用事を思い出して、
席を外してしまったとする。
するとBさんは「使用中」の印を何度となく調べ続けることとなる。
</p>

<h3>ロックの無視</h3>

<p>
「使用中」の印がついていたとしても、別に操作ができないわけではない。
Bさんがめんどくさがって「使用中」の印を調べなかったとしたら...。
</p>

<h3>デッドロック</h3>

<p>
ロックするリソースがひとつだけであれば良いが、
複数ある場合、デッドロックの問題が生じ得る。
</p>

<p><a href="/computer/programming/algorithm/lock/deadlock.html">詳細</a></p>

<h2>ファイルのロックについての参考</h2>

<p><a href="https://ja.wikipedia.org/wiki/ファイルロック"
	>wikipediaのページ</a></p>
