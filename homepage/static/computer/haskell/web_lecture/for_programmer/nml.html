NML(Nano Markup Language)

<p>(工事中 20%)</p>

<h2>はじめに</h2>

<p>Data.TreeモジュールのTree型の値を扱う例題を挙げる。</p>

<h2>定義</h2>

<p>
XMLを徹底的にシンプルにしたNML(Nano Markup Language)を考えよう。
NMLの開きタグは&lt;hoge&gt;といった形であり閉じタグは&lt;/hoge&gt;となる。
子要素を持たないタグを&lt;hoge/&gt;と書けるようにする。
また実体参照として最小限必要な&amp;lt;、&amp;gt;、&amp;amp;だけは
使えるようにしよう。
</p>

<p>
コードが簡単になるので閉じタグが存在しなかった場合にはエラーとせずに
暗黙の閉じタグが存在するものとして処理する。
タグ自体が&gt;によって閉じていない場合文字列の最後に&gt;があるものとして
処理する。
また、上記以外の実体参照や正しくない形式の実体参照があった場合、
それ以降のデータが存在しないものとして処理する。
空白文字のみのテキストデータは削除する。
テキストデータの先頭と末尾の空白は削除する。
それ以外の空白文字は処理しない。
</p>

<p>
このような構文エラーに対する過度な寛容さはPerl的と言える。
実用的なコードではあまりこのようにはしないほうが良い。
HaskellではMaybeモナド等のエラーを扱うモナドを導入することで
エラー処理がきれいに書けるようになる。
それまではPerl的寛容さに対する読者の寛容を請う。
</p>

<p>
また、タグに囲まれた文字列と子要素を持たないタグとは同じものとして扱われる。
</p>

<ul>
<li>&lt;hoge&gt;piyo&lt;/hoge&gt;</li>
<li>&lt;hoge&gt;&lt;piyo&gt;&lt;/piyo&gt;&lt;/hoge&gt;</li>
</ul>

<p>のふたつは同じものとして扱われる。</p>

<p><a href="/computer/haskell/web_lecture/for_programmer/codes/nml.hs"
	>nml.hs</a></p>

<h2>字句解析</h2>

<p>
まずは文字列を開きタグ、閉じタグ、タグでない文字列の3つのトークンに分解する。
</p>

<h3>型Token</h3>

<p><code>data Token = Open String | Close String | Text String deriving Show</code></p>

<p>それぞれ開きタグ、閉じタグ、タグでない文字列に対応する。</p>

<h3>関数token</h3>

<p>
関数tokenはトークンをひと切り出し残りの文字列とともに返す。
空文字列や不正な実体参照の場合にはNothingを返す。
</p>

<p><code>token :: String -&gt; (Token, String)<br/>
token ('&lt;' : s) = Just $ tag s<br/>
token ('&amp;' : s) = entity s<br/>
token s = Just $ let (tx, r) = span (`notElem` "&lt;&amp;") s in (Text tx, r)</code></p>

<p>
&lt;があればタグを切り出し、&amp;があれば実体参照を切り出す。
どちらでもなければそれらが出現するまでをテキストとして切り出す。
</p>

<h4>タグの切り出し</h4>

<p>
タグを切り出す関数には最初の&lt;を落とした文字列がわたされる。
最初の文字が/ならば閉じタグを返し、そうでなければ開きタグを返す。
タグは&gt;で終わる。
</p>

<p><code>tag :: String -&gt; (Token, String)<br/>
tag ('/' : s) = case span (/= '&gt;') s of<br/>
	<span class="indent1">(tg, _ : r) -&gt; (Close tg, r)</span><br/>
	<span class="indent1">(tg, _) -&gt; (Close tg, "")</span><br/>
tag s = case span (/= '&gt;') s of<br/>
	<span class="indent1">(tg, _ : r) -&gt; (Open tg, r)</span><br/>
	<span class="indent1">(tg, _) -&gt; (Open tg, "")</span></code></p>

<p>
</p>

<h4>実体参照の切り出し</h4>

<h2>構文解析</h2>

<h2>煩悶</h2>

<p>
う、う、う...思いつかない。
XMLパーサとかどうだろうか。
XMLパーサと言ってしまうと誇大広告になってしまうので、
XMLもどきパーサと言っておいたほうが良いかもしれない。
XMLは思いのほか複雑なのだ。
JSONのほうがいいな。
</p>

<p>
JSONパーサを使るのはいいかもしれない。
前に作ったパーサコンビネータは使わない。
まずはJSONの規格を調べねばな。
</p>

<p><a href="https://ja.wikipedia.org/wiki/JavaScript_Object_Notation">Wikipedia: JSON</a></p>

<p>
いまいち、かな。
やはりXMLのサブセットのパーサのほうが良いような気がする。
タグと&amp;lt;、&amp;gt;、&amp;amp;だけ扱えればいいだろう。
これをNML(nano markup language)と勝手に名づけてそれのパーサを作ろう。
</p>

<p>
<a href="/computer/haskell/web_lecture/for_programmer/adt_export.html"
	>「構文: 代数的データ型のエクスポート」へもどる</a>
<a href="/computer/haskell/web_lecture/for_programmer"
	>「1から学ぶHaskell」トップへ</a>
</p>
