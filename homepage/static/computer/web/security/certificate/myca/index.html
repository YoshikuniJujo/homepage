オレオレ認証局の作成

<p>
<a href="http://www.webtech.co.jp/blog/developer-news/1159/"
>このページ</a>が参考になる。ただしGentooではファイルの位置が異なる。
また、OpenSSLのバージョンの違いによって、
以下のような変更が必要になる。
<ul>
<li>/etc/pki/tls/misc/CA -&gt; /etc/ssl/misc/CA.sh</li>
<li>/etc/pki/tls/openssl.cnf -&gt; /etc/ssl/openssl.cnf</li>
</ul>
</p>

<h2>必要なファイルの用意</h2>

<pre><code>% mkdir /home/tatsuya/phd03_white/oreore
% cd /home/tatsuya/phd03_white/oreore
% cp /etc/ssl/misc/CA.sh ./
% cp /etc/ssl/openssl.cnf ./
% vim CA.sh
% diff /etc/ssl/misc/CA.sh CA.sh
29a30,32
&gt; SSLEAY_CONFIG="-config /home/tatsuya/phd03_white/oreore/openssl.cnf"
&gt; CATOP="/home/tatsuya/phd03_white/oreore/"
&gt;
% vim openssl.cnf
% diff /etc/ssl/openssl.cnf openssl.cnf
42c42
&lt; dir		= ./demoCA		# Where everything is kept
---
&gt; dir		= /home/tatsuya/phd03_white/oreore/	# Where everything is kept
106c106
&lt; default_bits		= 1024
---
&gt; default_bits		= 2048
129c129
&lt; countryName_default	= AU
---
&lt; countryName_default	= JP
134c134
&lt; stateOrProvinceName_default	= Some-State
---
&gt; stateOrProvinceName_default	= Gunma
139c139
&lt; 0.organizationName_default		= Internet Widgits Pty Ltd
---
&gt; 0.organizationName_default		= Yoshikuni
</code></pre>

<p><a href="/computer/web/security/certificate/myca/CA.sh.diff.txt"
	>CA.sh.diff</a></p>

<p><a href="/computer/web/security/certificate/myca/openssl.cnf.diff.txt"
	>openssl.cnf.diff</a></p>

<h2>CAの作成</h2>

<pre><code>% ./CA.sh -newca
(必要事項を入力)</code></pre>

<p>
cacert.pemが証明書、private/cakey.pemが秘密鍵となる。
</p>

<h2>CSRの作成</h2>

<pre><code>% ./CA.sh -newreq
(必要事項を入力、CNのところはlocalhostとしておく)</code></pre>

<h2>証明書に署名する</h2>

<pre><code>% ./CA.sh -sign
(CSRを確認しy)</code></pre>

<h2>出来たファイル</h2>

<p>
newkey.pem newreq.pem newcert.pem
</p>

<pre><code>% mkdir reqs
% mv newreq.pem reqs/first_csr.pem
% mv newkey.pem private/first_key.pem
% mv newcert.pem certs/first_cert.pem</code></pre>

<p>
private/first_key.pemが秘密鍵、certs/first_cert.pemが証明書となる。
</p>

<h2>出来た証明書の確認</h2>

<h3>確認方法</h3>

<p>
ローカルにシンプルなサーバを立ち上げてFirefoxから接続してみる。
先にFirefoxに認証局をインポートしておく必要があるが普段使いのプロファイルに
インポートするとセキュリティホールとなり得るので、証明書テスト用のプロファイルを
作成しておくことにする。
</p>

<h3>証明書確認用のFirefoxプロファイルを作成する</h3>

<p>
<a
href="https://support.mozilla.org/ja/kb/profile-manager-create-and-remove-firefox-profiles"
>Firefoxのプロファイルの管理のページ</a>が参考になる。
以下のような手順で新しいプロファイルを作成する。
<ol>
<li>Firefoxを完全に終了させる</li>
<li>% firefox -P</li>
<li>「新しいプロファイルを作成」</li>
<li>「次へ」</li>
<li>プロファイル名を入力(ここでは「test_cert」とする)</li>
<li>「完了」</li>
</ol>
</p>

<h3>プロファイルを指定してFirefoxを起動する</h3>

<pre><code>% firefox --help
...
Firefox options
...
  -P &lt;profile&gt;		Start with &lt;profile&gt;
...
% firefox -P test_cert</code></pre>

<p>これで、まっさらな状態のプロファイルでFirefoxが立ち上がるはずだ。</p>

<h3>オレオレ認証局の自己署名証明書をインポートする</h3>

<p>
以下の手順で認証局の証明書をFirefoxにインポートする。
<ol>
<li>「編集」</li>
<li>「設定」</li>
<li>「証明書を表示」</li>
<li>「インポート」</li>
<li>oreore/cacert.pemを選択する</li>
</ol>
</p>

<h3>ローカルなサーバを走らせてFirefoxから接続する</h3>

<p>
ここでは自分で作ったHaskellパッケージの<a
href="https://hackage.haskell.org/package/peyotls"
>peyotls</a>を使用する。
このパッケージの<a href="https://hackage.haskell.org/package/peyotls-0.1.6.5/src/examples/simpleServer.hs"
>simpleServer.hs</a>(<a
href="/computer/web/security/certificate/myca/simpleServer.hs"
>ソースコード</a>)を使うことにしよう。
<pre><code>% mkdir local_test
% cp private/first_key.pem local_test/localhost.sample_key
% cp certs/first_cert.pem local_test/localhost.sample_crt
% openssl rsa -in local_test/localhost.sample_key -out local_test/localhost.sample_key
% runhaskell simpleServer.hs local_test</code></pre>
Firefoxからhttps://localhostに接続する。
</p>
